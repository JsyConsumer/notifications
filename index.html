<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prices.je Notifications</title>

  <!-- iOS installable web app -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="https://mmo.aiircdn.com/1466/689b69c47dc12.png">
  <meta name="theme-color" content="#0068B3">

  <!-- OneSignal Web SDK (v16) -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    :root { --blue:#0068B3; --text:#182026; --bg:#fff; --ok:#0a7f2e; --err:#b00020; }
    html,body { height:100% }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text) }
    .wrap { max-width:720px; margin:0 auto; padding:24px }
    h1 { margin:0 0 8px; font-size:1.25rem }
    p { margin:8px 0 16px; line-height:1.45 }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .muted { opacity:.75 } .ok{ color:var(--ok); font-weight:600 } .err{ color:var(--err); font-weight:600 }
    .hidden { display:none!important }
    .btn { appearance:none; border:0; border-radius:10px; padding:.8rem 1rem; font-weight:600; cursor:pointer }
    .btn.primary { background:var(--blue); color:#fff } .btn.outline{ background:transparent; color:var(--blue); border:2px solid var(--blue) }
    .btn:disabled { opacity:.55; cursor:not-allowed }
  </style>

  <script>
    const ONESIGNAL_APP_ID     = "e0befc38-70d7-40c6-9a4d-ad74d23863c7";
    const SAFARI_WEB_ID        = "";   // optional for v16
    const SERVICE_WORKER_PATH  = "OneSignalSDKWorker.js";
    const SERVICE_WORKER_SCOPE = "/";

    // iOS detection: prefer navigator.standalone; fall back to display-mode
    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const inStandalone = (('standalone' in navigator) && navigator.standalone) ||
                         (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);

    // OneSignal init
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function(OneSignal) {
      try {
        await OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          safariWebId: SAFARI_WEB_ID || undefined,
          serviceWorkerPath: SERVICE_WORKER_PATH,
          serviceWorkerParam: { scope: SERVICE_WORKER_SCOPE },
          allowLocalhostAsSecureOrigin: true
        });

        // If we’re on iOS but NOT launched from Home Screen, show instructions and bail.
        if (isiOS && !inStandalone) {
          setStatus("Install to Home Screen first (Share → Add to Home Screen), then open from the icon.", "err");
          document.getElementById("iosHint").classList.remove("hidden");
          document.getElementById("enable").disabled = true;
          return;
        }

        const granted = OneSignal.Notifications.permission; // boolean
        setStatus(`Browser permission: ${granted ? "granted" : "default/denied"}`, granted ? "ok" : "muted");
        if (granted) await afterGranted(OneSignal);

        OneSignal.Notifications.addEventListener("permissionChange", (permission) => {
          setStatus(`Browser permission: ${permission ? "granted" : "denied"}`, permission ? "ok" : "err");
          if (permission) afterGranted(OneSignal);
        });
      } catch (e) {
        setStatus("Failed to initialize OneSignal.", "err");
        console.error(e);
      }
    });

    async function onEnableClick() {
      const btn = document.getElementById("enable");
      btn.disabled = true;

      // Guard again at click-time for iOS HS requirement
      if (isiOS && !inStandalone) {
        document.getElementById("iosHint").classList.remove("hidden");
        setStatus("Install to Home Screen and open from there to enable.", "err");
        btn.disabled = false;
        return;
      }

      try {
        const OneSignal = window.OneSignal;
        await OneSignal.Notifications.requestPermission(); // v16: no return
        const granted = OneSignal.Notifications.permission;
        setStatus(`User permission: ${granted ? "granted" : "denied"}`, granted ? "ok" : "err");
        if (granted) await afterGranted(OneSignal);
        else btn.disabled = false;
      } catch (e) {
        setStatus("Permission request failed.", "err");
        console.error(e);
        btn.disabled = false;
      }
    }

    async function afterGranted(OneSignal) {
      try {
        try { console.log("OneSignal user ID:", await OneSignal.User.getId()); } catch {}
        document.getElementById("done").classList.remove("hidden");
        document.getElementById("enable").classList.add("hidden");
        document.getElementById("disable").classList.remove("hidden");
      } catch (e) {
        setStatus("Subscribed, but a final step failed.", "err");
        console.error(e);
        document.getElementById("enable").disabled = false;
      }
    }

    async function onDisableClick() {
      const btn = document.getElementById("disable");
      btn.disabled = true;
      const OneSignal = window.OneSignal;
      try {
        if (OneSignal?.User?.PushSubscription?.optOut) {
          await OneSignal.User.PushSubscription.optOut();
        } else if (OneSignal?.Notifications?.unsubscribe) {
          await OneSignal.Notifications.unsubscribe();
        }
        setStatus("Notifications disabled on this device.", "ok");
        document.getElementById("done").classList.add("hidden");
        document.getElementById("enable").classList.remove("hidden");
        btn.classList.add("hidden");
      } catch (e) {
        console.error(e);
        setStatus("Couldn’t disable here. Use your browser’s site settings.", "err");
      } finally {
        btn.disabled = false;
      }
    }

    function setStatus(text, cls = "muted") {
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = cls;
    }
  </script>
</head>
<body>
  <main class="wrap">
    <h1>Enable Notifications</h1>
    <p class="muted">Turn on push notifications for this device.</p>

    <div id="iosHint" class="muted hidden" aria-live="polite">
      <p><strong>iPhone/iPad:</strong> open this page in <strong>Safari</strong>, tap <strong>Share</strong> → <strong>Add to Home Screen</strong>, then open it from the new Home-Screen icon and tap Enable.</p>
    </div>

    <div class="row" role="group" aria-label="Push actions">
      <button id="enable" class="btn primary" onclick="onEnableClick()">Enable notifications</button>
      <button id="disable" class="btn outline hidden" onclick="onDisableClick()">Disable on this device</button>
      <span id="status" class="muted" aria-live="polite">Waiting for your action…</span>
      <span id="done" class="ok hidden" aria-live="polite">All set! You can close this page.</span>
    </div>

    <details>
      <summary>Troubleshooting</summary>
      <p class="muted">iOS only allows web push from Home-Screen web apps (iOS 16.4+). If you blocked notifications before, use your browser’s Site settings to allow them.</p>
    </details>
  </main>
</body>
</html>
