<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prices.je Notifications</title>

  <!-- OneSignal Web SDK (v16) -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; }
    .card { max-width: 640px; margin: 0 auto; padding: 1.5rem; border: 1px solid rgba(0,0,0,.08); border-radius: 16px; }
    h1 { margin: 0 0 0.5rem; font-size: 1.25rem; }
    p { margin: 0.5rem 0 1rem; line-height: 1.45; }
    button { padding: .8rem 1rem; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; }
    button.primary { background: #111; color: #fff; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { opacity: .75; font-size: .95rem; }
    .ok { color: #0a7f2e; font-weight: 600; }
    .err { color: #b00020; font-weight: 600; }
    .hidden { display: none; }
    .row { margin-top: 1rem; display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    code { background: rgba(0,0,0,.06); padding: .1rem .35rem; border-radius: 6px; }
  </style>

  <script>
    const ONESIGNAL_APP_ID = "e0befc38-70d7-40c6-9a4d-ad74d23863c7";
    const SAFARI_WEB_ID = "";               // optional
    const SERVICE_WORKER_PATH = "OneSignalSDKWorker.js";
    const SERVICE_WORKER_SCOPE = "/";
    const DEFAULT_RETURN_URL = "https://prices.je/"; // optional

    const params = new URLSearchParams(location.search);
    const externalId = params.get("uid") || "";  // your user/account ID
    const returnUrl  = params.get("return") || DEFAULT_RETURN_URL;
    const tagsParam  = params.get("tags") || ""; // CSV of key:value

    // iOS needs Add to Home Screen (PWA) for web push
    const isStandalone = window.matchMedia?.("(display-mode: standalone)")?.matches || window.navigator.standalone === true;
    const iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // Parse tags from ?tags=plan:pro,tier:gold → { plan: "pro", tier: "gold" }
    function parseTags(csv) {
      if (!csv) return null;
      const obj = {};
      csv.split(",").forEach(pair => {
        const [k, v] = pair.split(":").map(s => (s || "").trim());
        if (k) obj[k] = v ?? "1";
      });
      return Object.keys(obj).length ? obj : null;
    }

    // OneSignal v16 deferred init
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function(OneSignal) {
      try {
        await OneSignal.init({
          appId: ONESIGNAL_APP_ID,
          safariWebId: SAFARI_WEB_ID || undefined,
          serviceWorkerPath: SERVICE_WORKER_PATH,
          serviceWorkerParam: { scope: SERVICE_WORKER_SCOPE },
          allowLocalhostAsSecureOrigin: true
        });

        // Pre-attach your external user ID (alias) if you have it
        if (externalId) {
          try { await OneSignal.login(externalId); } catch (e) { console.warn("login() will retry after permission:", e); }
        }

        const perm = await OneSignal.Notifications.getPermissionStatus(); // "default" | "granted" | "denied"
        updateStatus(`Browser permission: ${perm}`, perm === "granted" ? "ok" : "muted");
        if (perm === "granted") {
          await finalizeSubscription(OneSignal);
        }
      } catch (e) {
        updateStatus("Failed to initialize OneSignal.", "err");
        console.error(e);
      }
    });

    async function requestPermission() {
      const btn = document.getElementById("btn");
      btn.disabled = true;

      if (iOS && !isStandalone) {
        document.getElementById("iosHint").classList.remove("hidden");
        btn.disabled = false;
        return;
      }

      try {
        const OneSignal = window.OneSignal;
        const result = await OneSignal.Notifications.requestPermission(); // "granted" | "denied"
        updateStatus(`User permission: ${result}`, result === "granted" ? "ok" : "err");
        if (result === "granted") {
          await finalizeSubscription(OneSignal);
        } else {
          btn.disabled = false;
        }
      } catch (e) {
        updateStatus("Permission request failed.", "err");
        console.error(e);
        btn.disabled = false;
      }
    }

    async function finalizeSubscription(OneSignal) {
      try {
        // Ensure external_id is set so you can target by External User ID in OneSignal
        if (externalId) {
          try { await OneSignal.login(externalId); } catch {}
        }

        // Optionally set tags for segmentation (visible in OneSignal dashboard)
        const tags = parseTags(tagsParam);
        if (tags) {
          try { await OneSignal.User.addTags(tags); } catch (e) { console.warn("addTags failed:", e); }
        }

        // (Optional) fetch the OneSignal user ID for debugging
        try {
          const playerId = await OneSignal.User.getId();
          console.log("OneSignal user ID:", playerId);
        } catch {}

        document.getElementById("done").classList.remove("hidden");
        document.getElementById("btn").classList.add("hidden");
        setTimeout(() => { if (returnUrl) location.href = returnUrl; }, 700);

      } catch (e) {
        updateStatus("Subscription failed after permission.", "err");
        console.error(e);
        document.getElementById("btn").disabled = false;
      }
    }

    function updateStatus(text, cls = "muted") {
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = cls;
    }
  </script>
</head>
<body>
  <div class="card">
    <h1>Enable Notifications</h1>
    <p class="muted">Turn on push notifications for your device.</p>

    <div id="iosHint" class="muted hidden">
      <p><strong>On iPhone/iPad:</strong> first add this page to your Home Screen, open it from there, then tap Enable.</p>
      <p>Tap <strong>Share</strong> → <strong>Add to Home Screen</strong>, then re-open.</p>
    </div>

    <div class="row">
      <button id="btn" class="primary" onclick="requestPermission()">Enable notifications</button>
      <span id="status" class="muted">Waiting for your action…</span>
      <span id="done" class="ok hidden">All set! You can close this page.</span>
    </div>

    <p class="muted">
      Tip: Link here with
      <code>?uid=&lt;EXTERNAL_ID&gt;&amp;tags=plan:pro,tier:gold&amp;return=&lt;URL&gt;</code>
    </p>
  </div>
</body>
</html>
